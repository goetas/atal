<?xml version="1.0" encoding="UTF-8"?>
<project name="package" default="package" basedir="../../">
    <property file="build/build.properties" />

     <target name="package">
		 <delete dir="${path.results/lib" />
		 <delete dir="${path.package}" />
		 <mkdir dir="${path.results}/lib" />
		 <mkdir dir="${path.package}" />
		 <exec
            os="Linux"
            outputProperty="version.number"
            command="git rev-parse HEAD"
            dir="${project.basedir}"
            />
		<phingcall target="copyFilesToResultsLib" />
		
        <phingcall target="packageFiles" />
     	
        <phingcall target="packagePear" />
    </target>

	<target name="copyFilesToResultsLib">
		<delete dir="${path.results}/lib/atal" />
		<mkdir dir="${path.results}/lib/atal" />
		
		<delete dir="${path.results}/lib/pluginsys" />
		<mkdir dir="${path.results}/lib/pluginsys" />
			
		<delete dir="${path.results}/lib/xmldom" />
		<mkdir dir="${path.results}/lib/xmldom" />

        <copy todir="${path.results}/lib/atal">
            <filterchain>
                <replacetokens begintoken="@@" endtoken="@@">
                    <token key="version" value="${version.number}" />
                </replacetokens>
            </filterchain>
            <fileset dir="${path.lib}">
                <include name="**/**" />
            </fileset>
        </copy>
		<copy todir="${path.results}/lib/xmldom">
            <fileset dir="${path.vendors}/xmldom/src">
                <include name="**/**" />
            </fileset>
        </copy>
		<copy todir="${path.results}/lib/pluginsys">
            <fileset dir="${path.vendors}/pluginsys/src">
                <include name="**/**" />
            </fileset>
        </copy>
	</target>

	<target name="packageFiles">
		<zip destfile="${path.package}/ATal.zip">
            <fileset dir="${path.results}/lib">
                <include name="**/**" />
            </fileset>
        </zip>
        
	</target>

	<target name="packagePear">
		<pearpkg name="ATal" dir="${path.results}/lib" destfile="${path.results}/lib/package.xml">
            <fileset dir="${path.results}/lib">
                <include name="**/**" />
            </fileset>
            <option name="notes">Release Notes</option>
            <option name="description">A Template engine for PHP</option>
            <option name="summary">A Template engine for PHP</option>
            <option name="version" value="${version.string}" />
            <option name="state" value="stable" />
			<option name="license" value="LGPL" />
			
            <mapping name="maintainers">
                <element>
                    <element key="handle" value="goetas" />
                    <element key="name" value="Asmir Mustafic" />
                    <element key="email" value="goetas@lignano.it" />
                    <element key="role" value="lead" />
                </element>
            </mapping>
        </pearpkg>
	</target>

</project>
